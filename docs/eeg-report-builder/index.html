<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EEG Report Builder</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      max-width: 1100px;
      margin-inline: auto;
      line-height: 1.4;
      background: #f5f5f5;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }
    .container {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr);
      gap: 1.5rem;
      align-items: flex-start;
    }
    fieldset {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.9rem 1.1rem;
      margin-bottom: 0.9rem;
      background: #fff;
    }
    legend {
      font-weight: 600;
      padding: 0 0.4rem;
    }
    label {
      display: block;
      margin-bottom: 0.35rem;
      font-size: 0.9rem;
    }
    .inline-options label {
      display: inline-flex;
      align-items: center;
      margin-right: 1rem;
      margin-bottom: 0.35rem;
    }
    .small {
      font-size: 0.8rem;
      color: #666;
    }
    input[type="text"],
    select,
    textarea.template-input {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.45rem;
      font-size: 0.9rem;
      font-family: inherit;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 0.15rem;
      margin-bottom: 0.4rem;
    }
    textarea.template-input {
      min-height: 60px;
      resize: vertical;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .output-buttons {
      display: flex;
      gap: 0.5rem;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #4b5563;
    }
    button:active {
      transform: scale(0.98);
    }

    /* OUTPUT AREA: editable, wrapped, light green-beige */
    #output {
      width: 100%;
      min-height: 450px;
      resize: vertical;
      padding: 0.75rem;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid #b5c2a8;
      background: #f3f6e8;
      color: #000;
      white-space: pre-wrap;  /* preserve line breaks + wrap */
      word-wrap: break-word;  /* wrap long tokens */
      box-sizing: border-box;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.03) inset;
    }

    #copy-status {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 0.25rem;
      min-height: 1em;
    }

    .section-group-title {
      font-weight: 600;
      margin-top: 0.2rem;
      margin-bottom: 0.35rem;
      font-size: 0.9rem;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
      #output {
        min-height: 320px;
      }
    }
  </style>
</head>
<body>
  <h1>EEG Report Builder</h1>
  <p class="subtitle">
    Choose study type and sections, then generate a draft report. You can freely edit the text before copying.
  </p>

  <div class="container">
    <!-- LEFT: controls -->
    <div>

      <!-- Study type -->
      <fieldset>
        <legend>Study Type</legend>
        <div class="inline-options">
          <label>
            <input type="radio" name="studyType" value="videoEEG" checked />
            Video-EEG
          </label>
          <label>
            <input type="radio" name="studyType" value="ceribell" />
            Ceribell Rapid EEG
          </label>
        </div>
        <p class="small">
          Study type changes the style of the procedure text, findings, and impression blocks.
        </p>
      </fieldset>

      <!-- Sections to include -->
      <fieldset>
        <legend>Sections to Include</legend>
        <label>
          <input type="checkbox" id="includeProcedure" checked />
          Procedure / Context
        </label>
        <label>
          <input type="checkbox" id="includeFindings" checked />
          Findings
        </label>
        <label>
          <input type="checkbox" id="includeImpression" checked />
          Impression
        </label>
        <label>
          <input type="checkbox" id="includeCeribellInterim" />
          Ceribell Interim Update
        </label>
        <p class="small">
          Uncheck to generate only a subset (e.g., Findings-only for prelim notes, or Interim-only for a quick update).
        </p>
      </fieldset>

      <!-- VIDEO-EEG OPTIONS -->
      <div id="videoEEG-options">
        <fieldset>
          <legend>Video-EEG – Procedure</legend>
          <label>
            Study Duration
            <input type="text" id="vEEG-duration" placeholder="e.g., 30 minutes; 2 hours; 24 hours" />
          </label>

          <label>
            Pertinent History
            <textarea id="vEEG-history" class="template-input"
              placeholder="e.g., evaluation for focal seizures, spells of concern, etc."></textarea>
          </label>

          <div class="section-group-title">Level of Alertness</div>
          <div class="inline-options" style="flex-wrap: wrap;">
            <label><input type="radio" name="vEEG-alertness" value="awakeAsleep" checked /> awake and asleep</label>
            <label><input type="radio" name="vEEG-alertness" value="awakeDrowsy" /> awake and drowsy</label>
            <label><input type="radio" name="vEEG-alertness" value="awake" /> awake</label>
            <label><input type="radio" name="vEEG-alertness" value="confused" /> confused</label>
            <label><input type="radio" name="vEEG-alertness" value="lethargic" /> lethargic</label>
            <label><input type="radio" name="vEEG-alertness" value="obtunded" /> obtunded</label>
            <label><input type="radio" name="vEEG-alertness" value="stuporous" /> stuporous</label>
            <label><input type="radio" name="vEEG-alertness" value="comatose" /> comatose</label>
          </div>

          <div class="section-group-title">AEDs/ASMs during study</div>
          <div class="inline-options" style="flex-wrap: wrap; display:block;">
            <label><input type="checkbox" class="vEEG-aed" value="levetiracetam" /> levetiracetam</label>
            <label><input type="checkbox" class="vEEG-aed" value="propofol" /> propofol</label>
            <label><input type="checkbox" class="vEEG-aed" value="midazolam" /> midazolam</label>
            <label><input type="checkbox" class="vEEG-aed" value="lorazepam" /> lorazepam</label>
            <label><input type="checkbox" class="vEEG-aed" value="lacosamide" /> lacosamide</label>
            <label><input type="checkbox" class="vEEG-aed" value="valproic acid" /> valproic acid</label>
            <label><input type="checkbox" class="vEEG-aed" value="dexmedetomidine" /> dexmedetomidine</label>
            <label><input type="checkbox" class="vEEG-aed" value="clobazam" /> clobazam</label>
            <label><input type="checkbox" class="vEEG-aed" value="phenytoin" /> phenytoin</label>
            <label><input type="checkbox" class="vEEG-aed" value="clonazepam" /> clonazepam</label>
            <label><input type="checkbox" class="vEEG-aed" value="topiramate" /> topiramate</label>
            <label><input type="checkbox" class="vEEG-aed" value="oxcarbazepine" /> oxcarbazepine</label>
            <label>
              Other:
              <input type="text" id="vEEG-aeds-other" placeholder="e.g., perampanel, brivaracetam" />
            </label>
          </div>

          <label>
            Artifacts / Limitations
            <input type="text" id="vEEG-artifacts" placeholder="[Within expected tolerances]" />
          </label>
        </fieldset>

        <fieldset>
          <legend>Video-EEG – Findings</legend>
          <div class="section-group-title">Background</div>
          <select id="vEEG-background">
            <option value="">[leave blank]</option>
            <option value="The background was continuous and reactive. During maximal wakefulness, the background consisted of a poorly organized 6–7 Hz moderate-voltage rhythm distributed symmetrically in posterior head regions.">
              6–7 Hz, continuous, reactive
            </option>
            <option value="The background was continuous and reactive and during wakefulness consisted of an 8–9 Hz moderate-voltage rhythm that was well modulated and distributed symmetrically in the posterior head regions.">
              8–9 Hz, continuous, reactive
            </option>
            <option value="The background was continuous and reactive and during wakefulness consisted of a 9–10 Hz moderate-voltage rhythm that was well modulated and distributed symmetrically in the posterior head regions.">
              9–10 Hz, continuous, reactive
            </option>
            <option value="The background was continuous and reactive and during wakefulness consisted of a 10–11 Hz moderate-voltage rhythm that was well modulated and distributed symmetrically in the posterior head regions.">
              10–11 Hz, continuous, reactive
            </option>
            <option value="The recording lacked an organized background of wakefulness. The background was continuous and reactive and consisted predominantly of diffuse theta-predominant mixed-frequency activity.">
              Diffuse theta-predominant
            </option>
            <option value="The recording lacked wakefulness. The background was continuous and modestly reactive and consisted predominantly of diffuse delta-predominant mixed-frequency activity.">
              Diffuse delta-predominant
            </option>
            <option value="No evidence of wakefulness; the background consisted of delta-predominant mixed-frequency activity.">
              No evidence of wakefulness
            </option>
          </select>

          <label>
            Slowing (free text)
            <input type="text" id="vEEG-slowing" placeholder="e.g., Focal slowing over the left temporal region" />
          </label>

          <label>
            Interictal epileptiform activity
            <input type="text" id="vEEG-interictal" placeholder="e.g., None; rare left temporal spikes" />
          </label>

          <label>
            Ictal activity
            <input type="text" id="vEEG-ictal" placeholder="e.g., None; 3 focal seizures arising from ..." />
          </label>

          <label>
            Other findings / artifacts
            <textarea id="vEEG-other" class="template-input"
              placeholder="e.g., EMG artifact obscuring portions of the study"></textarea>
          </label>

          <div class="section-group-title">Sleep</div>
          <select id="vEEG-sleep">
            <option value="">[leave blank]</option>
            <option value="Stage 1 and 2 sleep were seen, including vertex waves, K complexes, and sleep spindles.">
              Stage 1–2 with K complexes & spindles
            </option>
            <option value="Stage 1 sleep was seen, including vertex waves.">
              Stage 1 only
            </option>
            <option value="Awake and drowsy states were captured. Drowsiness was characterized by attenuation and fragmentation of the posterior background rhythm.">
              Awake & drowsy only
            </option>
            <option value="Only the awake state was captured.">
              Awake only
            </option>
            <option value="Sleep architecture was not recorded.">
              Sleep architecture not recorded
            </option>
          </select>

          <div class="section-group-title">Activation Procedures</div>
          <label>
            Hyperventilation
            <select id="vEEG-hv">
              <option value="">[not mentioned]</option>
              <option value="Hyperventilation was not performed.">Not performed</option>
              <option value="Hyperventilation was performed and resulted in mild diffuse slowing.">
                Performed – mild diffuse slowing
              </option>
            </select>
          </label>
          <label>
            Photic stimulation
            <select id="vEEG-photic">
              <option value="">[not mentioned]</option>
              <option value="Photic stimulation was not performed.">
                Not performed
              </option>
              <option value="Photic stimulation was performed and did not elicit a photoparoxysmal response.">
                Performed – no photoparoxysmal response
              </option>
              <option value="Photic stimulation was performed and photic driving was seen at [] Hz.">
                Performed – photic driving
              </option>
            </select>
          </label>
        </fieldset>

        <fieldset>
          <legend>Video-EEG – Impression</legend>
          <div class="inline-options">
            <label>
              <input type="radio" name="vEEG-impression-type" value="normal" checked />
              Normal
            </label>
            <label>
              <input type="radio" name="vEEG-impression-type" value="abnormal" />
              Abnormal
            </label>
          </div>

          <label>
            If abnormal – key abnormal findings
            <textarea id="vEEG-impression-abnormal" class="template-input"
              placeholder="e.g., Focal left temporal epileptiform discharges and focal slowing consistent with cortical dysfunction in this region."></textarea>
          </label>

          <label>
            Consistent with / Comment
            <textarea id="vEEG-impression-comment" class="template-input"
              placeholder="e.g., These findings are consistent with increased risk of focal seizures arising from the left temporal region."></textarea>
          </label>
        </fieldset>
      </div>

      <!-- CERIBELL OPTIONS -->
      <div id="ceribell-options" class="hidden">
        <fieldset>
          <legend>Ceribell – Procedure</legend>
          <label>
            Time parameters
            <input type="text" id="c-time" placeholder="e.g., 2-hour Ceribell recording beginning at 14:32" />
          </label>
          <label>
            Pertinent history
            <textarea id="c-history" class="template-input"
              placeholder="e.g., Evaluation for possible nonconvulsive status epilepticus in ICU patient with ..."></textarea>
          </label>

          <div class="section-group-title">Level of Alertness</div>
          <div class="inline-options" style="flex-wrap: wrap;">
            <label><input type="radio" name="c-alertness" value="awakeAsleep" checked /> awake and asleep</label>
            <label><input type="radio" name="c-alertness" value="awakeDrowsy" /> awake and drowsy</label>
            <label><input type="radio" name="c-alertness" value="awake" /> awake</label>
            <label><input type="radio" name="c-alertness" value="confused" /> confused</label>
            <label><input type="radio" name="c-alertness" value="lethargic" /> lethargic</label>
            <label><input type="radio" name="c-alertness" value="obtunded" /> obtunded</label>
            <label><input type="radio" name="c-alertness" value="stuporous" /> stuporous</label>
            <label><input type="radio" name="c-alertness" value="comatose" /> comatose</label>
          </div>

          <div class="section-group-title">AEDs/ASMs during study</div>
          <div class="inline-options" style="flex-wrap: wrap; display:block;">
            <label><input type="checkbox" class="c-aed" value="levetiracetam" /> levetiracetam</label>
            <label><input type="checkbox" class="c-aed" value="propofol" /> propofol</label>
            <label><input type="checkbox" class="c-aed" value="midazolam" /> midazolam</label>
            <label><input type="checkbox" class="c-aed" value="lorazepam" /> lorazepam</label>
            <label><input type="checkbox" class="c-aed" value="lacosamide" /> lacosamide</label>
            <label><input type="checkbox" class="c-aed" value="valproic acid" /> valproic acid</label>
            <label><input type="checkbox" class="c-aed" value="dexmedetomidine" /> dexmedetomidine</label>
            <label><input type="checkbox" class="c-aed" value="clobazam" /> clobazam</label>
            <label><input type="checkbox" class="c-aed" value="phenytoin" /> phenytoin</label>
            <label><input type="checkbox" class="c-aed" value="clonazepam" /> clonazepam</label>
            <label><input type="checkbox" class="c-aed" value="topiramate" /> topiramate</label>
            <label><input type="checkbox" class="c-aed" value="oxcarbazepine" /> oxcarbazepine</label>
            <label>
              Other:
              <input type="text" id="c-aeds-other" placeholder="e.g., perampanel, brivaracetam" />
            </label>
          </div>
        </fieldset>

        <fieldset>
          <legend>Ceribell – Findings</legend>
          <label>
            Background activity
            <textarea id="c-background" class="template-input"
              placeholder="Within limitations of the study montage, appreciable background activity consisted of ..."></textarea>
          </label>
          <label>
            Interictal epileptiform activity
            <input type="text" id="c-interictal" placeholder="e.g., None; limited sensitivity of montage" />
          </label>
          <label>
            Rhythmic / periodic patterns
            <input type="text" id="c-rp" placeholder="e.g., None; GRDA; LPDs at 1–2 Hz over ..." />
          </label>
          <label>
            Ictal activity
            <input type="text" id="c-ictal" placeholder="e.g., None; electrographic seizures at ..." />
          </label>
          <label>
            Other events / artifacts
            <textarea id="c-other" class="template-input"
              placeholder="e.g., Movement and EMG artifact intermittently limit interpretation."></textarea>
          </label>
        </fieldset>

        <fieldset>
          <legend>Ceribell – Impression</legend>
          <label>
            Summary phrase
            <textarea id="c-impression-main" class="template-input"
              placeholder="e.g., This Ceribell study was notable for ... or This Ceribell study showed no seizures, sustained rhythmic periodic patterns, or overt epileptiform activity."></textarea>
          </label>
          <label>
            Consistent with / Comment
            <textarea id="c-impression-comment" class="template-input"
              placeholder="e.g., These findings are consistent with ..."></textarea>
          </label>
          <label>
            Limited montage disclaimer (optional)
            <textarea id="c-disclaimer" class="template-input"
              placeholder="Of note, this study was performed using a rapid EEG system with a limited circumferential montage as detailed above. Depending on persistent clinical concerns for seizures, a standard or prolonged video-EEG study may be warranted."></textarea>
          </label>
        </fieldset>

        <!-- CERIBELL INTERIM OPTIONS (section under Ceribell) -->
        <div id="ceribell-interim-options">
          <fieldset>
            <legend>Ceribell – Interim Update</legend>

            <p class="small">
              Use this for quick, running updates while a Ceribell study is in progress.
              It generates a focused interim section with a header line and seizure/NCSE status.
            </p>

            <label>
              Reviewed through (time)
              <input type="text" id="ci-through-time"
                     placeholder="e.g., 15:30, 17:45, or 'approximately 2 hours of recording'" />
            </label>

            <div class="section-group-title">So far, results are consistent with:</div>
            <div class="inline-options">
              <label>
                <input type="radio" name="ci-background" value="severeSedation" checked />
                diffuse severe encephalopathy (as can be seen with heavy sedation)
              </label>
              <label>
                <input type="radio" name="ci-background" value="diffuseEnceph" />
                diffuse encephalopathy
              </label>
              <label>
                <input type="radio" name="ci-background" value="awake" />
                an awake patient
              </label>
              <label>
                <input type="radio" name="ci-background" value="myogenic" />
                excessive myogenic artifact without clear evidence of wakefulness or of NCSE
              </label>
            </div>

            <div class="section-group-title">In regards to seizures / NCSE:</div>
            <div class="inline-options" style="display:block;">
              <label>
                <input type="radio" name="ci-seizureStatus" value="negativeClean" checked />
                NEGATIVE for NCSE and no overt seizures, rhythmic periodic patterns, or overt epileptiform activity have been seen
              </label>
              <label>
                <input type="radio" name="ci-seizureStatus" value="negativeNotable" />
                NEGATIVE for NCSE but notable for [findings]
              </label>
              <label>
                <input type="radio" name="ci-seizureStatus" value="concernNCSE" />
                Notable for concerns of [] which in the appropriate clinical context may represent NCSE; [team] team made aware at [time].
              </label>
            </div>

            <!-- Free-text slots for the bracketed pieces -->
            <label>
              If "NEGATIVE but notable" selected – findings:
              <input type="text" id="ci-seizure-findings"
                     placeholder="e.g., intermittent GRDA, LPDs over right temporal region" />
            </label>

            <label>
              If "concerns of []" selected – concerning finding:
              <input type="text" id="ci-seizure-concern"
                     placeholder="e.g., evolving right temporal rhythmic delta activity" />
            </label>

            <label>
              Team notified (e.g., 'neuro ICU team'):
              <input type="text" id="ci-team" placeholder="e.g., neuro ICU team" />
            </label>

            <label>
              Time team made aware:
              <input type="text" id="ci-team-time" placeholder="e.g., 16:05" />
            </label>
          </fieldset>
        </div>
      </div>

    </div>

    <!-- RIGHT: output -->
    <div>
      <div class="output-header">
        <strong>Generated Report</strong>
        <div class="output-buttons">
          <button id="generate-btn" type="button">Generate</button>
          <button id="copy-btn" type="button" class="secondary">Copy</button>
        </div>
      </div>
      <textarea id="output"></textarea>
      <p id="copy-status"></p>
    </div>
  </div>

  <script>
    // --- Utility helpers ---

    function getSelectedRadio(name, defaultValue = "") {
      const nodes = document.querySelectorAll(`input[name="${name}"]`);
      for (const n of nodes) if (n.checked) return n.value;
      return defaultValue;
    }

    function nonEmptyLinesJoin(lines) {
      // Join non-empty lines with a blank line between each
      return lines
        .map(l => (l == null ? "" : String(l)))
        .filter(l => l.trim().length > 0)
        .join("\n\n");
    }

    function withDefault(value, defaultText = "[none]") {
      const v = (value || "").trim();
      return v.length ? v : defaultText;
    }

    function getAlertnessText(groupName) {
      const key = getSelectedRadio(groupName, "awakeAsleep");
      const map = {
        awakeAsleep: "awake and asleep",
        awakeDrowsy: "awake and drowsy",
        awake: "awake",
        confused: "confused",
        lethargic: "lethargic",
        obtunded: "obtunded",
        stuporous: "stuporous",
        comatose: "comatose"
      };
      return map[key] || "[none]";
    }

    function getAEDString(prefix) {
      const selected = Array.from(
        document.querySelectorAll(`.${prefix}-aed:checked`)
      ).map(el => el.value);

      const otherEl = document.getElementById(`${prefix}-aeds-other`);
      const other = (otherEl ? otherEl.value : "").trim();

      if (other) selected.push(other);

      return selected.length ? selected.join(", ") : "[none]";
    }

    // --- Builder functions: VIDEO-EEG ---

    function buildVideoEEGProcedure() {
      const duration = document.getElementById("vEEG-duration").value;
      const historyRaw = document.getElementById("vEEG-history").value;
      const alertnessText = getAlertnessText("vEEG-alertness");
      const aedsText = getAEDString("vEEG");
      const artifacts = document.getElementById("vEEG-artifacts").value;

      const historyText = (historyRaw || "[]").trim() || "[]";

      const lines = [];

      lines.push("Video-EEG Study Report");
      lines.push(`Study Duration: ${withDefault(duration)}`);
      lines.push(
        "Pertinent History:\nAs per documentation, the patient is a " + historyText + "."
      );
      lines.push("Level of Alertness:\n" + alertnessText);
      lines.push("AED/ASMs during study:\n" + aedsText);
      lines.push(
        "Technical Aspects: This video-EEG study was done with scalp electrodes positioned according to the 10–20 International system of electrode placement. Video-EEG data were recorded continuously and digitally stored."
      );
      lines.push("Artifacts / Limitations:\n" + withDefault(artifacts, "[Within expected tolerances]"));

      return nonEmptyLinesJoin(lines);
    }

    function buildVideoEEGFindings() {
      const background = document.getElementById("vEEG-background").value;
      const slowing = document.getElementById("vEEG-slowing").value;
      const interictal = document.getElementById("vEEG-interictal").value;
      const ictal = document.getElementById("vEEG-ictal").value;
      const other = document.getElementById("vEEG-other").value;
      const sleep = document.getElementById("vEEG-sleep").value;
      const hv = document.getElementById("vEEG-hv").value;
      const photic = document.getElementById("vEEG-photic").value;

      const lines = [];

      lines.push("EEG Findings\n--------------------");
      lines.push("Background:\n--------------------");
      lines.push(withDefault(background));
      lines.push("Slowing:");
      lines.push(withDefault(slowing));

      lines.push("Epileptiform Activity\n--------------------");
      lines.push("Interictal epileptiform activity:");
      lines.push(withDefault(interictal));
      lines.push("Ictal activity:");
      lines.push(withDefault(ictal));
      lines.push("Other\n--------");
      lines.push("Other findings / artifacts:");
      lines.push(withDefault(other));

      lines.push("Sleep Recordings");
      lines.push(withDefault(sleep));

      lines.push("Activation Procedures");
      lines.push(withDefault(hv));
      lines.push(withDefault(photic));

      return nonEmptyLinesJoin(lines);
    }

    function buildVideoEEGImpression() {
      const type = getSelectedRadio("vEEG-impression-type", "normal");
      const abnormal = document.getElementById("vEEG-impression-abnormal").value;
      const comment = document.getElementById("vEEG-impression-comment").value;

      const lines = [];
      lines.push("EEG Impression\n--------------------");

      if (type === "normal") {
        lines.push(
          "This EEG study was within normal limits in awake [and drowsy] [and sleep] states as recorded. No seizures nor epileptiform discharges were seen. [Depending on clinical considerations, a prolonged study capturing deeper sleep states may merit consideration]."
        );
      } else {
        lines.push("This EEG study was abnormal due to:");
        lines.push(withDefault(abnormal));
        lines.push("Interpretation comment:");
        lines.push(withDefault(comment));
      }

      return nonEmptyLinesJoin(lines);
    }

    // --- Builder functions: CERIBELL ---

    function buildCeribellProcedure() {
      const time = document.getElementById("c-time").value;
      const historyRaw = document.getElementById("c-history").value;
      const alertnessText = getAlertnessText("c-alertness");
      const aedsText = getAEDString("c");

      const historyText = (historyRaw || "[]").trim() || "[]";

      const lines = [];
      lines.push("Ceribell Rapid EEG Study Report\n----------------------------------------");
      lines.push("Time Parameters:\n" + withDefault(time));
      lines.push(
        "Pertinent History:\nAs per documentation, the patient is a " + historyText + "."
      );
      lines.push("Level of Alertness:\n" + alertnessText);
      lines.push("AEDs/ASMs during study:\n" + aedsText);
      lines.push(
        "Technical Aspects: This rapid EEG study was performed using a 10-lead, 8-channel system (Ceribell) positioned circumferentially and recorded in a bipolar montage, with EEG channels corresponding approximately to the Fp1–F7, F7–T3, T3–T5, and T5–O1 sites on the left and the Fp2–F8, F8–T4, T4–T6, and T6–O2 sites on the right according to the International 10–20 System. There was no coverage of parasagittal electrode sites. Data were acquired digitally at a sampling rate of 250 Hz with a frequency response of 0.5–100 Hz. The entirety of the study was reviewed. In addition, findings and events identified by a proprietary decision support algorithm (ClarityPro) were reviewed."
      );

      return nonEmptyLinesJoin(lines);
    }

    function buildCeribellFindings() {
      const background = document.getElementById("c-background").value;
      const interictal = document.getElementById("c-interictal").value;
      const rp = document.getElementById("c-rp").value;
      const ictal = document.getElementById("c-ictal").value;
      const other = document.getElementById("c-other").value;

      const lines = [];

      lines.push("Ceribell Findings\n--------------------");
      lines.push("Background activity:");
      lines.push(withDefault(background));
      lines.push("Interictal epileptiform activity:");
      lines.push(withDefault(interictal));
      lines.push("Rhythmic / periodic patterns:");
      lines.push(withDefault(rp));
      lines.push("Ictal activity:");
      lines.push(withDefault(ictal));
      lines.push("Other events / artifacts:");
      lines.push(withDefault(other));

      return nonEmptyLinesJoin(lines);
    }

    function buildCeribellImpression() {
      const main = document.getElementById("c-impression-main").value;
      const comment = document.getElementById("c-impression-comment").value;
      const disclaimer = document.getElementById("c-disclaimer").value;

      const lines = [];
      lines.push("Ceribell Impression\n--------------------");
      lines.push(withDefault(main));
      lines.push("Additional comment:");
      lines.push(withDefault(comment));
      lines.push("Limited montage / follow-up comment:");
      lines.push(withDefault(disclaimer));

      return nonEmptyLinesJoin(lines);
    }

    // Ceribell Interim; includeHeader = true when it's the ONLY Ceribell section used
    function buildCeribellInterim(includeHeader) {
      const through = document.getElementById("ci-through-time").value.trim();

      const bgKey = getSelectedRadio("ci-background", "severeSedation");
      const seizureKey = getSelectedRadio("ci-seizureStatus", "negativeClean");

      const findings = document.getElementById("ci-seizure-findings").value.trim();
      const concern = document.getElementById("ci-seizure-concern").value.trim();
      const team = document.getElementById("ci-team").value.trim();
      const notifyTime = document.getElementById("ci-team-time").value.trim();

      const bgMap = {
        severeSedation: "diffuse severe encephalopathy (as can be seen with heavy sedation)",
        diffuseEnceph: "diffuse encephalopathy",
        awake: "an awake patient",
        myogenic: "excessive myogenic artifact without clear evidence of wakefulness or of NCSE"
      };

      let seizureSentence = "";
      if (seizureKey === "negativeClean") {
        seizureSentence =
          "NEGATIVE for NCSE and no overt seizures, rhythmic periodic patterns, or overt epileptiform activity have been seen.";
      } else if (seizureKey === "negativeNotable") {
        const f = findings || "[findings]";
        seizureSentence = `NEGATIVE for NCSE but notable for ${f}.`;
      } else if (seizureKey === "concernNCSE") {
        const c = concern || "electrographic abnormalities";
        const t = team || "[team]";
        const timePhrase = notifyTime ? ` at ${notifyTime}` : " at [time]";
        seizureSentence =
          `Notable for concerns of ${c} which in the appropriate clinical context may represent NCSE; ` +
          `${t} made aware${timePhrase}.`;
      }

      const lines = [];

      if (includeHeader) {
        lines.push('Ceribell "Rapid EEG" Study Report');
        lines.push('---------------------------------');
      }

      const timePart = through ? ` through ${through}` : "";
      lines.push(`INTERIM UPDATE: Initial portions of study reviewed${timePart}.`);

      const bgPhrase = bgMap[bgKey];
      if (bgPhrase) {
        lines.push(`So far, results are consistent with ${bgPhrase}.`);
      }

      if (seizureSentence) {
        lines.push(`In regards to seizures / NCSE: ${seizureSentence}`);
      }

      return nonEmptyLinesJoin(lines);
    }

    // --- Main build function ---

    function buildOutput() {
      const studyType = getSelectedRadio("studyType", "videoEEG");
      const includeProcedure = document.getElementById("includeProcedure").checked;
      const includeFindings = document.getElementById("includeFindings").checked;
      const includeImpression = document.getElementById("includeImpression").checked;
      const includeCeribellInterim = document.getElementById("includeCeribellInterim").checked;

      const blocks = [];

      if (studyType === "videoEEG") {
        if (includeProcedure)  blocks.push(buildVideoEEGProcedure());
        if (includeFindings)   blocks.push(buildVideoEEGFindings());
        if (includeImpression) blocks.push(buildVideoEEGImpression());
      } else {
        // Ceribell
        const anyMainCeribellSections = includeProcedure || includeFindings || includeImpression;

        if (includeProcedure)  blocks.push(buildCeribellProcedure());
        if (includeFindings)   blocks.push(buildCeribellFindings());
        if (includeImpression) blocks.push(buildCeribellImpression());

        if (includeCeribellInterim) {
          // Include header only if Interim is the *only* Ceribell section
          blocks.push(buildCeribellInterim(!anyMainCeribellSections));
        }
      }

      document.getElementById("output").value = blocks
        .filter(b => b.trim().length > 0)
        .join("\n\n");
    }

    // --- Copy to clipboard ---

    async function copyOutput() {
      const out = document.getElementById("output");
      const status = document.getElementById("copy-status");
      const text = out.value;

      if (!text.trim()) {
        status.textContent = "Nothing to copy yet.";
        return;
      }

      try {
        await navigator.clipboard.writeText(text);
        status.textContent = "Copied.";
      } catch (e) {
        out.select();
        document.execCommand("copy");
        status.textContent = "Copied (fallback).";
      }

      setTimeout(() => (status.textContent = ""), 2000);
    }

    // --- UI wiring ---

    function updateStudyTypeVisibility() {
      const studyType = getSelectedRadio("studyType", "videoEEG");
      const v = document.getElementById("videoEEG-options");
      const c = document.getElementById("ceribell-options");

      if (studyType === "videoEEG") {
        v.classList.remove("hidden");
        c.classList.add("hidden");
      } else {
        v.classList.add("hidden");
        c.classList.remove("hidden");
      }
    }

    function init() {
      // Study type switching
      document.querySelectorAll('input[name="studyType"]').forEach(radio => {
        radio.addEventListener("change", updateStudyTypeVisibility);
      });

      document.getElementById("generate-btn").addEventListener("click", buildOutput);
      document.getElementById("copy-btn").addEventListener("click", copyOutput);

      // Default disclaimer text for Ceribell
      document.getElementById("c-disclaimer").value =
        "Of note, this study was performed using a rapid EEG system with a limited circumferential montage as detailed above. Depending on persistent clinical concerns for seizures, a standard or prolonged video-EEG study may be warranted.";

      // Default history brackets so they’re ready to edit
      document.getElementById("vEEG-history").value = "[]";
      document.getElementById("c-history").value = "[]";

      // Default artifacts text for Video-EEG
      document.getElementById("vEEG-artifacts").value = "[Within expected tolerances]";

      updateStudyTypeVisibility();
      buildOutput(); // initial skeleton
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
